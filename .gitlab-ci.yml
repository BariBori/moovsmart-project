image: maven:3.6.1-jdk-11-slim

stages:
  - build
  - deploy_production

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$pem_file_full_path" | tr -d '\r' | ssh-add - > /dev/null
  - ssh-add <(echo "$pem_file_full_path")
  - mkdir -p ~/.ssh
  - chmod 600 ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

Build Backend:
  stage: build
  artifacts:
    paths:
      - "$backend_source_location_" 
  only:
    - deployment

Build Frontend:
  stage: build
  image: node:10
  cache:
    paths:
      - moovsmart/node_modules/
  script:
    - cd moovsmart
    - npm ci
    - npm run build --quiet
  artifacts:
    paths:
      - moovsmart/build/
  only:
    - master

Deploy to Production:
  stage: deploy_production
  script:
    scp  -i $pem_file_full_path $frontend_source_location ec2-user@$remote_address:$frontend_remote_location
    scp  -i $pem_file_full_path $backend_source_location ec2-user@$remote_address:$backend_remote_location/project-1.0-SNAPSHOT.jar.new
    ssh -i $pem_file_full_path ec2-user@$remote_address './shutdown.sh; mv project-1.0-SNAPSHOT.jar.new project.jar; ./start.sh'
  only:
    - deployment