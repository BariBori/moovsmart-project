image: maven:3.6.3-jdk-11

stages:
  - build
#   - deploy

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$pem_file_full_path" | tr -d '\r' | ssh-add - > /dev/null
  - ssh-add <(echo "$pem_file_full_path")
  - mkdir -p ~/.ssh
  - chmod 600 ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

Build Backend:
  stage: build
  script:
    - mvn package -DskipTests=true -q
  artifacts:
    paths:
      - target/project-1.0-SNAPSHOT.jar.new
  only:
    - deployment

Build Frontend:
  stage: build
  image: node:10
  cache:
    paths:
      - moovsmart/node_modules/
  script:
    - cd moovsmart
    - npm ci
    - npm run build --quiet
  artifacts:
    paths:
      - moovsmart/build/
  only:
    - master

# deploy:
#   stage: deploy_production
#   script:
#     - scp -i $pem_file_full_path target/project-1.0-SNAPSHOT.jar.new "$server_user"@"$remote_address":/home/ec2-user/frontend
#     - scp -i $pem_file_full_path $backend_source_location "$server_user"@"$remote_address":/home/ec2-user/project-1.0-SNAPSHOT.jar.new
#     - ssh -i $pem_file_full_path "$server_user"@"$remote_address" './shutdown.sh; mv project-1.0-SNAPSHOT.jar.new project.jar; ./start.sh'
#     only:
#      - deployment